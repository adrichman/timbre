<!DOCTYPE html>
<html>
<head>
  <title>timbre | host</title>    
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="../bower_components/bootstrap/dist/css/bootstrap.css">
  <script type="text/javascript" src="http://cdn.pubnub.com/pubnub.js"></script>
</head>
<body>
  <div class="container">
    <div class="row">
      <div class="col-md-6 col-md-offset-3">
        <h1 class="text-center">WebRTC Supercharged With PubNub</h1>
        <input type="text" id="remote-user-input" placeholder="Remote User ID" />
        <input id="connect" class="btn btn-default" href="#" value="Connect"/>

        <br />
        <input id="get-user" class="btn btn-default" href="#" value="Get My UserID" /><div id="user-id"><p></p></div>

        <br />

        <input type="text" id="input" placeholder="Type Message Here" disabled="disabled" />
        <input id="send" class="btn btn-default" href="#" value="Send" disabled="disabled" />

        <br />
        <br />

        <div id="response" style="max-height: 250px; display: block; overflow: auto;">
          [Responses sent across the WebRTC Data Channel will show up here]
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-6 col-md-offset-3">
        <h3>What is Happening?</h3>
        <p>
          When the page starts up it creates two PubNub clients: A and B. When you press the connect button user B subscribes directly to user A. When you send a message, it first detects if there is a connection between the two users and if not, it creates a WebRTC Peer Connection. This allows user A to publish string based messages to user B using the WebRTC Data Channel technology. Cool!
        </p>
      </div>
    </div>
  </div>
  <audio id="out" autoplay></audio>
  <script type='text/javascript' src='../assets/js/webrtc-beta-pubnub.js'></script>
  <script type='text/javascript' src='../bower_components/jquery/dist/jquery.js'></script>
  <script type='text/javascript' src='../bower_components/bootstrap/dist/js/bootstrap.js'></script>
  <script type="text/javascript">

navigator.getUserMedia = navigator.webkitGetUserMedia;

var pubnub,
    currentCall,
    localStream;

var init = function (name) {
  uuid = name;

  window.pubnub = PUBNUB.init({
    publish_key: 'pub-c-7070d569-77ab-48d3-97ca-c0c3f7ab6403',
    subscribe_key: 'sub-c-49a2a468-ced1-11e2-a5be-02ee2ddab7fe',
    uuid: name
  });

  pubnub.onNewConnection(function(uuid) {
    if (localStream) {
      call(uuid);
    }
  });

  console.log(uuid);
};

var call = function(remote) {
  pubnub.publish({
    user: remote,
    stream: localStream
  });

  pubnub.subscribe({
    user: remote,
    stream: function(bad, event) {
      window.you = document.querySelector('#remote-call-audio');
      you.src = URL.createObjectURL(event.stream);
      window.remoteStream = event.stream;
    }
  });
};

navigator.getUserMedia({ audio: true }, function(stream) {
  window.me = document.querySelector('#self-call-audio');
  me.src = URL.createObjectURL(stream);
  me.play();
  localStream = stream;
}, function(err) {
  console.log(err);
});

  </script>
  <audio id="self-call-audio"></audio>
  <audio id="remote-call-audio"></script>
</body>
</html>